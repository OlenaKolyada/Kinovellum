# Тестовые сценарии для Vulpecula

## FR-001: Добавление записи о просмотре

| | |
|---|---|
| **Test ID** | T-001 |
| **Requirement** | FR-001 |
| **Scenario** | Добавление новой записи о просмотре фильма с оценкой и комментарием |
| **Preconditions** | 1. Пользователь аутентифицирован<br>2. Фильм "The Shawshank Redemption" существует в базе данных |
| **Test Steps** | **Given:** Пользователь открыл форму добавления записи<br>**When:** Заполнены поля:<br>- Фильм: "The Shawshank Redemption"<br>- Дата просмотра: "2025-10-15"<br>- Оценка: 9<br>- Комментарий: "Потрясающий фильм о надежде"<br>**And:** Нажата кнопка "Сохранить"<br>**Then:**<br>- Запись успешно создана<br>- Возвращен статус 201<br>- Запись отображается в списке просмотров пользователя |
| **Test Data** | userId: "user:12345"<br>movieId: "movie:tt0111161"<br>Rating: 9/10 |
| **Pass Criteria** | 1. Запись создана в базе данных<br>2. Все поля сохранены корректно<br>3. Время отклика API < 500 мс |
| **Environment** | DEV (DynamoDB) |

## FR-002: Редактирование записи о просмотре

| | |
|---|---|
| **Test ID** | T-002 |
| **Requirement** | FR-002 |
| **Scenario** | Изменение оценки и комментария существующей записи |
| **Preconditions** | 1. Пользователь аутентифицирован<br>2. Существует запись с id="550e8400-e29b-41d4-a716-446655440000" |
| **Test Steps** | **Given:** Пользователь открыл запись для редактирования<br>**When:** Изменены поля:<br>- Оценка: 9 → 10<br>- Комментарий: "После повторного просмотра оценил еще выше"<br>**And:** Нажата кнопка "Обновить"<br>**Then:**<br>- Запись обновлена<br>- Возвращен статус 200<br>- Поле updatedAt обновлено<br>- Изменения отображаются в списке |
| **Test Data** | entryId: "550e8400-e29b-41d4-a716-446655440000"<br>Новая оценка: 10/10 |
| **Pass Criteria** | 1. Только указанные поля изменены<br>2. userId и movieId остались прежними<br>3. Время отклика API < 500 мс |
| **Environment** | STAGING |

## FR-003: Удаление записи о просмотре

| | |
|---|---|
| **Test ID** | T-003 |
| **Requirement** | FR-003 |
| **Scenario** | Удаление записи из дневника |
| **Preconditions** | 1. Пользователь аутентифицирован<br>2. Существует запись, принадлежащая пользователю |
| **Test Steps** | **Given:** Пользователь выбрал запись для удаления<br>**When:** Подтверждено удаление<br>**Then:**<br>- Запись удалена из базы данных<br>- Возвращен статус 204<br>- Запись не отображается в списке просмотров |
| **Test Data** | entryId: "550e8400-e29b-41d4-a716-446655440000"<br>userId: "user:12345" |
| **Pass Criteria** | 1. Запись физически удалена из БД<br>2. При попытке получить запись возвращается 404<br>3. Время отклика API < 500 мс |
| **Environment** | DEV |

## FR-004: Множественные записи для одного фильма

| | |
|---|---|
| **Test ID** | T-004 |
| **Requirement** | FR-004 |
| **Scenario** | Добавление нескольких записей для одного фильма (повторные просмотры) |
| **Preconditions** | 1. Пользователь аутентифицирован<br>2. Уже существует одна запись о просмотре "Inception" |
| **Test Steps** | **Given:** Пользователь хочет добавить повторный просмотр<br>**When:** Создается новая запись:<br>- Фильм: "Inception" (тот же movieId)<br>- Дата просмотра: "2025-10-20"<br>- Оценка: 10<br>- Комментарий: "Второй раз - еще лучше!"<br>**Then:**<br>- Запись успешно создана<br>- В списке две записи для одного фильма<br>- Обе записи различаются по id и дате |
| **Test Data** | movieId: "movie:tt1375666"<br>Первый просмотр: 2025-09-15, оценка 9<br>Второй просмотр: 2025-10-20, оценка 10 |
| **Pass Criteria** | 1. Система позволяет создать несколько записей для одного фильма<br>2. Каждая запись имеет уникальный id<br>3. Метод diary.byMovie возвращает обе записи |
| **Environment** | DEV |

## FR-005: Поиск фильма через TMDb

| | |
|---|---|
| **Test ID** | T-005 |
| **Requirement** | FR-005 |
| **Scenario** | Поиск фильма, которого нет в локальной базе, через TMDb API |
| **Preconditions** | 1. Фильм "Oppenheimer" отсутствует в локальной базе<br>2. TMDb API доступен |
| **Test Steps** | **Given:** Пользователь вводит название "Oppenheimer" в поиск<br>**When:** Система не находит фильм в локальной базе<br>**Then:**<br>- Выполняется запрос к TMDb API<br>- Фильм найден и сохранен в локальную базу<br>- Возвращены данные:<br>  • Title: "Oppenheimer"<br>  • Year: 2023<br>  • Director: "Christopher Nolan"<br>  • tmdbId сохранен |
| **Test Data** | Запрос: "Oppenheimer"<br>TMDb ID: "872585" |
| **Pass Criteria** | 1. Фильм сохранен в локальную базу<br>2. При повторном поиске запрос к TMDb не выполняется<br>3. Время первого поиска < 2 сек<br>4. Время повторного поиска < 500 мс |
| **Environment** | STAGING (с реальным TMDb API) |

## FR-006: Получение списка записей с фильтрацией

| | |
|---|---|
| **Test ID** | T-006 |
| **Requirement** | FR-006 |
| **Scenario** | Получение списка записей пользователя с фильтрацией по дате и оценке |
| **Preconditions** | 1. Пользователь аутентифицирован<br>2. В базе 20 записей пользователя за период 2025-01-01 до 2025-10-20 |
| **Test Steps** | **Given:** Пользователь запрашивает список своих записей<br>**When:** Применены фильтры:<br>- Дата: с 2025-10-01 по 2025-10-20<br>- Оценка: ≥ 8<br>**Then:**<br>- Возвращено 5 записей<br>- Все записи соответствуют фильтрам<br>- Записи отсортированы по дате (от новых к старым) |
| **Test Data** | userId: "user:12345"<br>Всего записей: 20<br>Записей с оценкой ≥8 в октябре: 5 |
| **Pass Criteria** | 1. Возвращены только записи, соответствующие фильтрам<br>2. Сортировка корректна<br>3. Время отклика API < 500 мс |
| **Environment** | STAGING |

## SEC-001: Защита записей пользователя

| | |
|---|---|
| **Test ID** | T-007 |
| **Requirement** | SEC-001 |
| **Scenario** | Попытка доступа к чужой записи о просмотре |
| **Preconditions** | 1. Пользователь A аутентифицирован (userId: "user:12345")<br>2. Существует запись пользователя B (userId: "user:67890") |
| **Test Steps** | **Given:** Пользователь A пытается получить запись пользователя B<br>**When:** Выполнен запрос diary.read с entryId принадлежащим пользователю B<br>**Then:**<br>- Система блокирует доступ<br>- Возвращен статус 403 Forbidden<br>- В логе зафиксирована попытка доступа |
| **Test Data** | Пользователь A: "user:12345"<br>Запись пользователя B: "550e8400-e29b-41d4-a716-446655440001" |
| **Pass Criteria** | 1. Доступ к записи запрещен<br>2. HTTP-код 403<br>3. Попытка залогирована с уровнем WARN |
| **Environment** | PROD-like |

## SEC-002: Аутентификация через Keycloak

| | |
|---|---|
| **Test ID** | T-008 |
| **Requirement** | SEC-002 |
| **Scenario** | Попытка доступа к API без токена аутентификации |
| **Preconditions** | API endpoints требуют аутентификации |
| **Test Steps** | **Given:** Пользователь не аутентифицирован<br>**When:** Выполнен запрос к diary.list без токена<br>**Then:**<br>- Система отклоняет запрос<br>- Возвращен статус 401 Unauthorized<br>- Сообщение: "Authentication required" |
| **Test Data** | Запрос без заголовка Authorization |
| **Pass Criteria** | 1. Доступ запрещен<br>2. HTTP-код 401<br>3. Данные не возвращены |
| **Environment** | STAGING (с Keycloak) |

## PERF-001: Производительность API под нагрузкой

| | |
|---|---|
| **Test ID** | T-009 |
| **Requirement** | PERF-001 |
| **Scenario** | Проверка времени отклика API при 100 одновременных запросах |
| **Preconditions** | Развернута тестовая среда с 1000 записей в БД |
| **Test Steps** | **Given:** Настройка JMeter сценария:<br>- 100 виртуальных пользователей<br>- Ramp-up: 10 сек<br>- Endpoint: diary.list<br>**When:** Запуск теста<br>**Then:**<br>- 95% запросов завершаются ≤ 500 мс<br>- Ошибок 0%<br>- CPU сервера ≤ 70% |
| **Test Data** | 100 одновременных запросов к diary.list |
| **Pass Criteria** | 1. p95 latency ≤ 500 мс<br>2. Error rate = 0%<br>3. CPU ≤ 70%<br>4. Memory ≤ 80% |
| **Environment** | Load Testing (отдельный сервер) |

## PERF-002: Производительность поиска фильмов

| | |
|---|---|
| **Test ID** | T-010 |
| **Requirement** | PERF-002 |
| **Scenario** | Проверка скорости поиска фильмов в локальной базе |
| **Preconditions** | База содержит 10 000 фильмов |
| **Test Steps** | **Given:** Пользователь выполняет поиск по названию<br>**When:** Запрос: "The"<br>**Then:**<br>- Возвращены релевантные результаты<br>- Время отклика < 500 мс<br>- Результаты отсортированы по релевантности |
| **Test Data** | База: 10 000 фильмов<br>Ожидаемые результаты: ~500 фильмов с "The" в названии |
| **Pass Criteria** | 1. Время отклика < 500 мс<br>2. Релевантные результаты в топ-10<br>3. Использованы индексы БД |
| **Environment** | STAGING |