# ADR-003: Choosing Keycloak for Authentication

**Status:** Accepted  
**Date:** 2025-10-22  
**Participants:** Developer, course instructors

## 1. Context and Problem

"How to implement secure user authentication and authorization in the Vulpecula application to ensure data protection (only owner sees their entries), meet course security requirements, and gain practical experience with enterprise identity management solutions?"

## 2. Architecturally Significant Requirements (ASR)

| Requirement ID | Requirement Text | Type | Source |
|----------------|------------------|------|--------|
| SEC-001 | Users can view only their own entries | NFR | Functional requirements |
| SEC-002 | API protection from unauthorized access | NFR | Technical specification |
| SEC-003 | Support for registration via third-party services (Google, social networks) | FR | Functional requirements |
| MAINT-002 | Simplifying user and role management | NFR | Technical specification |
| LEARN-002 | Learning enterprise approaches to identity management | NFR | Educational goals |
| TIME-001 | Minimizing authentication feature development time | NFR | Project timeline |

## 3. Analysis of Alternatives

| Requirement \ Solution | Custom JWT Implementation | Auth0 | Keycloak |
|------------------------|---------------------------|-------|----------|
| SEC-001 | ‚úÖ Full control | ‚úÖ | ‚úÖ |
| SEC-002 | ‚ö†Ô∏è Requires careful implementation | ‚úÖ Enterprise-grade | ‚úÖ Enterprise-grade |
| SEC-003 | ‚ùå Requires integration of each provider | ‚úÖ Easy configuration | ‚úÖ Easy configuration |
| MAINT-002 | ‚ùå Need to write management UI | ‚úÖ Ready-made UI | ‚úÖ Ready-made Admin Console |
| LEARN-002 | ‚ö†Ô∏è Basic JWT knowledge | ‚ö†Ô∏è SaaS solution | ‚úÖ OpenID Connect, SAML, OAuth2 |
| TIME-001 | ‚ùå 40+ hours development | ‚úÖ Fast integration | ‚úÖ Fast integration |
| Cost | ‚úÖ Free | ‚ö†Ô∏è $25+/month | ‚úÖ Free (self-hosted) |
| Configuration flexibility | ‚úÖ Maximum | ‚ö†Ô∏è Limited by plan | ‚úÖ Full |
| Security | ‚ö†Ô∏è Depends on implementation | ‚úÖ Proven | ‚úÖ Proven, active community |
| Refresh tokens support | ‚ö†Ô∏è Need to implement | ‚úÖ | ‚úÖ |

## 4. Selected Solution

**Keycloak** with:
* OpenID Connect protocol for authentication
* Realm for Vulpecula application
* Role-based access control (roles: user, admin)
* Social login providers (Google, GitHub)
* Deployment in Docker container (development) / AWS ECS (production)

**Configuration:**
* Client: `vulpecula-api`
* Redirect URIs for mobile application
* Token lifetime: access token 15 min, refresh token 30 days
* Password policy: minimum 8 characters, letters and numbers required

## 5. Rationale

The solution satisfies all critical requirements:

* **SEC-001**: Keycloak generates JWT tokens with user ID, which is used to verify entry ownership
* **SEC-002**: Proven enterprise-grade solution used in production applications (Red Hat SSO)
* **SEC-003**: Built-in support for 20+ identity providers (Google, Facebook, GitHub, etc.) without writing code
* **MAINT-002**: Ready-made Admin Console for managing users, roles, security settings
* **LEARN-002**: Learning OpenID Connect, OAuth2, SAML standards - important for enterprise development
* **TIME-001**: Ktor integration takes ~4-6 hours vs 40+ hours for custom implementation

Additional advantages:
* Built-in refresh tokens support
* User registration and email verification out of the box
* Forgot password flow
* Audit logging
* Brute force protection
* Active community and documentation

## 6. Consequences

* ‚úÖ **Positive:**
    * Development time savings (40+ hours)
    * Enterprise-grade security without deep security expertise
    * Ready-made UI for registration, login, profile management
    * Experience with industry-standard solution
    * Easy addition of new identity providers
    * Centralized management of all authentication aspects

* ‚ö†Ô∏è **Negative:**
    * Additional infrastructure component (requires deployment and monitoring)
    * Requires ~1GB RAM for Keycloak instance
    * More complex architecture for educational project
    * Need to learn concepts of realms, clients, roles

* üîß **Dependencies:**
    * ADR-001: Ktor integration with Keycloak via JWT validation
    * Requires HTTPS configuration for production (Let's Encrypt)
    * Requires database for Keycloak (can use separate PostgreSQL or DynamoDB via custom provider)

## 7. Verification

| Requirement | Verification Method | Result | Status |
|-------------|---------------------|--------|--------|
| SEC-001 | Attempt to access another user's entry | 403 Forbidden returned | ‚úÖ |
| SEC-002 | Access attempt without token | 401 Unauthorized returned | ‚úÖ |
| SEC-003 | Registration via Google | Successful registration and login | ‚úÖ |
| MAINT-002 | User creation via Admin Console | User created in 30 sec | ‚úÖ |
| LEARN-002 | Learning OpenID Connect flow | Understanding authorization code flow | ‚úÖ |
| TIME-001 | Integration time | 5 hours (setup + integration) | ‚úÖ |
