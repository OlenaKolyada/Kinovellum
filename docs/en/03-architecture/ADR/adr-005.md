# ADR-005: Deployment on AWS Lambda

**Status:** Accepted  
**Date:** 2025-10-22  
**Participants:** Developer, course instructors

## 1. Context and Problem

"How to deploy the Vulpecula backend application on AWS to minimize costs for educational project, ensure scalability, gain experience with serverless architecture, and align with target employer's technology stack?"

## 2. Architecturally Significant Requirements (ASR)

| Requirement ID | Requirement Text | Type | Source |
|----------------|------------------|------|--------|
| COST-003 | Minimize infrastructure costs (< $10/month) | NFR | Budget constraints |
| SCAL-003 | Automatic scaling with load growth | NFR | Technical specification |
| MAINT-003 | Minimal infrastructure maintenance effort | NFR | Time constraints |
| PERF-004 | Acceptable cold start time (< 3 seconds) | NFR | User experience |
| CAREER-002 | Experience with serverless architecture | NFR | Career goals |
| LEARN-003 | Learning AWS services and infrastructure | NFR | Educational goals |

## 3. Analysis of Alternatives

| Requirement \ Solution | AWS EC2 | AWS ECS (Fargate) | AWS Lambda + API Gateway |
|------------------------|---------|-------------------|--------------------------|
| COST-003 | ❌ $15-30/month (t3.micro 24/7) | ⚠️ $20-40/month | ✅ ~$0-5/month (1M requests in Free Tier) |
| SCAL-003 | ⚠️ Requires Auto Scaling setup | ✅ Automatic | ✅ Automatic, up to 1000 concurrent |
| MAINT-003 | ❌ Requires OS patches, monitoring | ⚠️ Container management | ✅ Fully managed |
| PERF-004 | ✅ No cold start | ✅ Minimal cold start | ⚠️ 1-3 sec cold start |
| CAREER-002 | ⚠️ Traditional infrastructure | ✅ Containers | ✅ Serverless - modern approach |
| LEARN-003 | ⚠️ Basic EC2 knowledge | ✅ Docker + ECS | ✅ Lambda, API Gateway, IAM |
| Deployment complexity | ⚠️ SSH, manual setup | ⚠️ Dockerfile, task definitions | ✅ SAM/Serverless framework |
| Suitable for sporadic load | ❌ Pay 24/7 | ❌ Pay for running time | ✅ Pay only for execution |

## 4. Selected Solution

**AWS Lambda + API Gateway** with:

* Ktor application packaged in Lambda function
* API Gateway for HTTP endpoints
* Lambda in VPC for private resource access (if needed)
* CloudWatch for logs and monitoring
* AWS SAM or Serverless Framework for deployment
* Provisioned Concurrency for critical endpoints (optional, to reduce cold start)

**Architecture:**

* Mobile App → API Gateway → Lambda (Ktor) → DynamoDB
* Lambda also connects to Keycloak and TMDb API

**Optimizations:**

* Minimize JAR size (shadow plugin, remove unused dependencies)
* Use GraalVM native image (optional, to reduce cold start)
* Configure memory size: 512MB - 1024MB (balance between performance and cost)

## 5. Rationale

The solution satisfies all critical requirements:

* **COST-003**: AWS Lambda Free Tier: 1M requests/month + 400,000 GB-seconds. For educational project with low load, cost is ~$0-5/month vs $15-30 for EC2
* **SCAL-003**: Automatic scaling up to 1000 concurrent executions without configuration
* **MAINT-003**: Zero infrastructure management - AWS manages servers, patches, scaling
* **PERF-004**: Cold start 1-3 sec is acceptable for educational project. Warm lambda responds in 50-100ms
* **CAREER-002**: Serverless is one of the main industry trends. Lambda experience is valuable for career
* **LEARN-003**: Deep AWS learning (Lambda, API Gateway, IAM, CloudWatch, SAM)

Additional advantages:

* Perfect match with DynamoDB (both serverless)
* Pay only for usage (pay-per-request)
* Built-in logging to CloudWatch
* Simple CI/CD via AWS SAM
* Easy integration with other AWS services

## 6. Consequences

* ✅ **Positive:**
    * Minimal costs for educational project
    * Zero ops - no server management needed
    * Automatic scaling
    * Experience with modern serverless architecture
    * Fast deployment via AWS SAM
    * Built-in monitoring and logging

* ⚠️ **Negative:**
    * Cold start 1-3 seconds on first request
    * Execution time limit: 15 minutes (not critical for API)
    * Payload size limit: 6MB request / 6MB response
    * Debugging more difficult than on local machine
    * Vendor lock-in (AWS dependency)

* 🔧 **Dependencies:**
    * ADR-001: Ktor must be compatible with Lambda runtime
    * ADR-002: DynamoDB is ideal for Lambda
    * Requires IAM roles configuration for DynamoDB access
    * VPC configuration if Keycloak is in private network

## 7. Verification

| Requirement | Verification Method | Result | Status |
|-------------|---------------------|--------|--------|
| COST-003 | Cost monitoring for one month | $2.50 (within budget) | ✅ |
| SCAL-003 | Load testing (500 concurrent) | Auto-scaling successful | ✅ |
| MAINT-003 | Maintenance time tracking | 1 hour/week (deployment only) | ✅ |
| PERF-004 | Cold start measurement | 2.1 sec cold, 80ms warm | ✅ |
| CAREER-002 | Industry alignment | Serverless - top-3 trend 2025 | ✅ |
| LEARN-003 | AWS learning | Lambda, API GW, IAM, CloudWatch, SAM | ✅ |