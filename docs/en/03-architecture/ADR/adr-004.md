# ADR-004: Caching TMDb Data in DynamoDB

**Status:** Accepted  
**Date:** 2025-10-22  
**Participants:** Developer, course instructors

## 1. Context and Problem

"How to organize movie information retrieval (title, year, director, poster) for the Vulpecula application to minimize external API dependency, reduce latency, comply with TMDb API limits, and ensure functionality when external service is unavailable?"

## 2. Architecturally Significant Requirements (ASR)

| Requirement ID | Requirement Text | Type | Source |
|----------------|------------------|------|--------|
| PERF-003 | Movie search time ≤500 ms | NFR | Technical specification |
| REL-002 | Application works when TMDb API is unavailable | NFR | Technical specification |
| COST-002 | Compliance with TMDb API rate limits (50 requests/sec for free tier) | NFR | TMDb limitations |
| FUNC-001 | Movie information available to all users | FR | Functional requirements |
| DATA-001 | Movie information relevance (update when necessary) | NFR | Business requirements |

## 3. Analysis of Alternatives

| Requirement \ Solution | Query TMDb Every Time | In-Memory Caching (Redis) | DynamoDB Caching |
|------------------------|----------------------|---------------------------|------------------|
| PERF-003 | ❌ 200-500ms per request | ✅ ~10ms | ✅ ~15ms |
| REL-002 | ❌ Complete dependency | ⚠️ Lost on restart | ✅ Persistent storage |
| COST-002 | ❌ Easy to exceed limit | ✅ Minimal requests | ✅ Minimal requests |
| FUNC-001 | ✅ | ✅ | ✅ |
| DATA-001 | ✅ Always up-to-date | ⚠️ Need TTL strategy | ⚠️ Need update strategy |
| Infrastructure cost | ✅ $0 | ⚠️ $15-30/month (Elasticache) | ✅ Within DynamoDB |
| Implementation complexity | ✅ Simple | ⚠️ Additional service | ✅ Use existing DB |
| Availability on Lambda cold start | ❌ | ⚠️ Need warm-up | ✅ Always available |

## 4. Selected Solution

**Caching in DynamoDB** with the following strategy:

**Data structure:**

* PK: MOVIE#tmdbId
* SK: METADATA
* Attributes:
    * title
    * originalTitle
    * releaseYear
    * director
    * genres
    * posterUrl
    * tmdbId
    * cachedAt (timestamp)
    * ttl (30 days for auto-cleanup)

**Working strategy (Cache-Aside Pattern):**

1. Movie search: check DynamoDB first
2. If found → return from cache
3. If NOT found → request TMDb API → save to DynamoDB → return result
4. TTL: 30 days (automatic deletion of stale entries)

**Data update:**

* Automatic: when adding viewing entry, check cache age (>30 days → update)
* Manual: Admin API for forced movie information update

## 5. Rationale

The solution satisfies all critical requirements:

* **PERF-003**: Reading from DynamoDB ~15ms vs 200-500ms TMDb request. Repeated searches of same movie are instant
* **REL-002**: When TMDb API is unavailable, application continues working with cached data. New movies temporarily unavailable, but existing ones work
* **COST-002**: One movie requested from TMDb only once. With 1000 users and 100 unique movies: 100 TMDb requests vs 100,000 without cache
* **FUNC-001**: All users access same movie data (shared cache)
* **DATA-001**: 30-day TTL provides reasonable balance between relevance and TMDb API load

Additional advantages:

* No additional infrastructure required (using existing DynamoDB)
* Automatic cleanup via DynamoDB TTL
* Reduced external service dependency
* Improved user experience (fast search)

## 6. Consequences

* ✅ **Positive:**
    * Significant performance improvement (15ms vs 200-500ms)
    * Savings on TMDb API requests
    * Increased application reliability
    * Simple implementation (using existing DB)
    * Automatic cleanup of stale data
    * Shared cache for all users (efficient resource usage)

* ⚠️ **Negative:**
    * Information may be outdated (up to 30 days)
    * Increased DynamoDB data volume (but within reasonable limits)
    * First request for new movie is slower (requires TMDb request)
    * Requires TMDb API error handling logic

* 🔧 **Dependencies:**
    * ADR-002: Using DynamoDB for cache storage
    * Requires API key for TMDb
    * TMDb rate limits monitoring

## 7. Verification

| Requirement | Verification Method | Result | Status |
|-------------|---------------------|--------|--------|
| PERF-003 | A/B test: with cache vs without cache | With cache: 15ms, without: 350ms | ✅ |
| REL-002 | Simulate TMDb unavailability | Cached movies available | ✅ |
| COST-002 | Request count (100 users, 7 days) | 250 TMDb requests vs 7000 without cache | ✅ |
| FUNC-001 | Check availability for different users | All see same data | ✅ |
| DATA-001 | Check automatic update | Data >30 days updates | ✅ |